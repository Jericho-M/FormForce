<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Force Plotter</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; }
        button { padding: 15px 30px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        button:disabled { background-color: #ccc; }
        #status { margin-bottom: 10px; color: #666; }
        canvas { max-width: 100%; }
    </style>
</head>
<body>

    <h1>⚖️ Bluetooth Scale</h1>
    <p id="status">Ready to connect...</p>
    <h2 id="valueDisplay">0.00 kg</h2>
    <button id="connectBtn" onclick="connectToBLE()">Connect to Arduino</button>
    <canvas id="forceChart"></canvas>

    <script>
        // --- CONFIGURATION ---
        // These must match the UUIDs in the Arduino Code
        const serviceUUID = "0000180f-0000-1000-8000-00805f9b34fb"; // 180F
        const charUUID =    "00002a19-0000-1000-8000-00805f9b34fb"; // 2A19

        let device, server, service, characteristic;
        const ctx = document.getElementById('forceChart').getContext('2d');

        // Setup Chart
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{ label: 'Force (kg)', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1 }]
            },
            options: { animation: false }
        });

        async function connectToBLE() {
            try {
                document.getElementById('status').innerText = "Scanning...";
                
                // 1. Request Device
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Arduino Scale' }],
                    optionalServices: [serviceUUID]
                });

                // 2. Connect to Server
                document.getElementById('status').innerText = "Connecting...";
                server = await device.gatt.connect();

                // 3. Get Service
                service = await server.getPrimaryService(serviceUUID);

                // 4. Get Characteristic
                characteristic = await service.getCharacteristic(charUUID);

                // 5. Subscribe to Notifications
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                document.getElementById('status').innerText = "Connected!";
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerText = "Connected";

                // Handle Disconnect
                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "Disconnected.";
                    document.getElementById('connectBtn').disabled = false;
                    alert("Device Disconnected");
                });

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "Error: " + error;
            }
        }

        function handleData(event) {
            // Convert raw bytes to String
            const decoder = new TextDecoder('utf-8');
            const value = decoder.decode(event.target.value);
            
            // Display Number
            document.getElementById('valueDisplay').innerText = value + " kg";

            // Update Chart
            const now = new Date().toLocaleTimeString();
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(parseFloat(value));
            chart.update();
        }
    </script>
</body>
</html>