<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormForce - Control Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Keeping your existing styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #1a1a1a; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 40px 20px; text-align: center; border-bottom: 3px solid #ff6b35; }
        .header h1 { font-size: 2.5rem; font-weight: 800; text-transform: uppercase; }
        .container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .content { max-width: 900px; width: 100%; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); padding: 40px; text-align: center; }
        
        #valueDisplay { font-size: 4rem; font-weight: 800; color: #ff6b35; margin: 20px 0; }
        
        /* Control Buttons Grid */
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 30px 0; }
        
        .btn { padding: 15px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; transition: transform 0.2s; color: white; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background-color: #22c55e; } /* Green */
        .btn-stop { background-color: #ef4444; }  /* Red */
        .btn-tare { background-color: #3b82f6; }  /* Blue */
        
        #connectBtn { background: #1a1a1a; width: 100%; margin-bottom: 20px; }

        .chart-container { height: 300px; width: 100%; }
    </style>
</head>
<body>

    <div class="header">
        <h1>FormForce</h1>
        <p>Wireless Control</p>
    </div>

    <div class="container">
        <div class="content">
            <button id="connectBtn" class="btn" onclick="connectToBLE()">ðŸ“¡ Connect to Device</button>
            <p id="status">Disconnected</p>

            <h2 id="valueDisplay">0.00 kg</h2>

            <div class="controls">
                <button class="btn btn-start" onclick="sendCommand('start')" disabled>Start</button>
                <button class="btn btn-stop" onclick="sendCommand('stop')" disabled>Stop</button>
                <button class="btn btn-tare" onclick="sendCommand('tare')" disabled>Tare</button>
            </div>

            <div class="chart-container">
                <canvas id="forceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214"; 
        const notifyUUID =  "19b10001-e8f2-537e-4f6c-d104768a1214"; // Read
        const commandUUID = "19b10002-e8f2-537e-4f6c-d104768a1214"; // Write (New!)

        let device, server, service, notifyChar, commandChar;
        const ctx = document.getElementById('forceChart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Force (kg)', data: [], borderColor: '#ff6b35', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { display: false } } }
        });

        async function connectToBLE() {
            try {
                document.getElementById('status').innerText = "Scanning...";
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [serviceUUID]
                });

                document.getElementById('status').innerText = "Connecting...";
                server = await device.gatt.connect();
                service = await server.getPrimaryService(serviceUUID);

                // 1. Get Notification Characteristic (For Reading Data)
                notifyChar = await service.getCharacteristic(notifyUUID);
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);

                // 2. Get Command Characteristic (For Sending Commands)
                commandChar = await service.getCharacteristic(commandUUID);

                // UI Updates
                document.getElementById('status').innerText = "Connected";
                document.getElementById('connectBtn').style.display = 'none';
                
                // Enable Control Buttons
                document.querySelectorAll('.controls button').forEach(b => b.disabled = false);

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "Error: " + error;
            }
        }

        // --- NEW FUNCTION TO SEND COMMANDS ---
        async function sendCommand(cmd) {
            if (!commandChar) return;
            try {
                // Encode string to bytes
                const encoder = new TextEncoder();
                await commandChar.writeValue(encoder.encode(cmd));
                console.log("Sent: " + cmd);
            } catch (e) {
                console.error("Send failed", e);
            }
        }

        function handleData(event) {
            const dataView = event.target.value;
            const massKg = dataView.getFloat32(0, true); 
            
            document.getElementById('valueDisplay').innerText = massKg.toFixed(2) + " kg";

            const now = new Date().toLocaleTimeString();
            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(massKg);
            chart.update();
        }
    </script>
</body>
</html>